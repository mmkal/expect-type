name: pkg.pr.new
on:
  pull_request: {}
  push:
    branches: [main, deps]

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable
      - run: pnpm install
      - run: pnpm build
      - name: publish with pkg.pr.new
        run: pnpm pkg-pr-new publish | tee pkg.pr.new.log
      - name: install arethetypeswrong
        run: npm install --global @arethetypeswrong/cli
      - name: download package again
        run: |
          url=$(cat pkg.pr.new.log | tr ' ' '\n' | grep 'https://pkg.pr.new/')
          curl --silent --location --output pkg.tgz $url
      - name: test with arethetypeswrong
        run: attw pkg.tgz
